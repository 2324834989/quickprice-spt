# 手动刷新价格功能说明

## ✨ 功能概述

新增了**快捷键手动刷新跳蚤市场价格**功能，让玩家可以随时获取最新的物品价格数据。

---

## ⌨️ 使用方法

### 快捷键
- **默认快捷键**: `F10`
- **功能**: 立即强制刷新跳蚤市场价格缓存
- **适用场景**:
  - 配合永久缓存模式使用，需要更新价格时手动刷新
  - 动态价格模式下，想获取最新跳蚤市场价格

### 配置修改
在 BepInEx 配置管理器（F12）中找到 `QuickPrice` → `4. v2.0 新增功能` → `刷新价格快捷键`，可以修改为任意键。

---

## 🎯 功能特点

### 1. **异步刷新，不阻塞游戏**
- 使用异步方法 `UpdatePricesAsync(force: true)`
- 刷新过程在后台进行，游戏可以正常操作
- 即使刷新需要30-60秒，游戏也不会卡顿

### 2. **防止重复刷新**
- 如果已有刷新任务在进行，会提示"价格刷新已在进行中"
- 防抖机制：两次手动刷新间隔至少 5 秒

### 3. **详细的状态反馈**
刷新时会在日志中显示：
```
===========================================
  🔄 开始手动刷新跳蚤市场价格...
  模式: 动态价格
===========================================
  ✅ 价格刷新成功！
  📊 物品数量: 4,236 个
  ⏱️  耗时: 45.3 秒
  📅 更新时间: 14:23:45
===========================================
  🎨 地面物品颜色缓存已清理
  💡 提示: 重新悬停物品即可看到最新价格
===========================================
```

### 4. **自动清理缓存**
刷新成功后，自动清理：
- 价格数据缓存（更新为最新数据）
- 地面物品颜色缓存（LootItemLabelPatch）
- 重新悬停物品即可看到最新价格和颜色

---

## 🔧 实现细节

### 代码修改点

#### 1. Settings.cs（配置文件）
添加了新的配置项：
```csharp
public static ConfigEntry<KeyCode> RefreshPricesKey;   // 刷新价格快捷键

RefreshPricesKey = config.Bind(
    "4. v2.0 新增功能",
    "刷新价格快捷键",
    KeyCode.F10,
    "按此键立即强制刷新跳蚤市场价格缓存\n" +
    "默认快捷键: F10\n" +
    "刷新过程异步进行，不会阻塞游戏\n" +
    "适用于动态价格模式，可随时获取最新跳蚤市场价格\n" +
    "💡 配合永久缓存模式使用，需要更新价格时手动刷新"
);
```

#### 2. Plugin.cs（主逻辑）
- **添加状态标志**:
  ```csharp
  private static bool _isRefreshingPrices = false;
  private static DateTime _lastManualRefresh = DateTime.MinValue;
  ```

- **Update() 方法中监听快捷键**:
  ```csharp
  if (Input.GetKeyDown(Settings.RefreshPricesKey.Value))
  {
      _ = RefreshPricesManuallyAsync();
  }
  ```

- **新增刷新方法 RefreshPricesManuallyAsync()**:
  - 防止重复刷新（检查 `_isRefreshingPrices` 标志）
  - 防抖机制（5秒间隔）
  - 调用 `PriceDataService.Instance.UpdatePricesAsync(force: true)`
  - 显示详细的进度和状态信息
  - 自动清理地面物品颜色缓存

---

## 📊 性能分析

### 刷新时间估算（4000个物品）

| 模式 | 预计耗时 | 说明 |
|------|---------|------|
| **静态价格** | 1-3 秒 | 从数据库读取基础价格表 |
| **动态价格** | 30-60 秒 | 遍历4000个物品查询跳蚤市场价格 |

### 网络请求分析
- **静态价格**: 1 次 HTTP 请求（获取完整价格表）
- **动态价格**:
  - 服务端：4000 次跳蚤市场查询（内部）
  - 客户端：1 次 HTTP 请求（获取结果）

### 对游戏的影响
- ✅ **不会造成卡顿**：异步执行，不阻塞主线程
- ✅ **不会掉帧**：刷新过程在后台进行
- ✅ **防抖保护**：5秒间隔，防止频繁刷新导致服务端压力

---

## 💡 使用建议

### 推荐配置组合

#### 方案1：永久缓存 + 手动刷新（推荐）
```
价格缓存模式: 永久缓存
使用动态价格: 开启
刷新价格快捷键: F10
```
**优点**:
- 启动时加载一次，之后无自动刷新开销
- 需要更新价格时按 F10 手动刷新
- 性能最优，无卡顿

#### 方案2：自动刷新 + 手动刷新
```
价格缓存模式: 10分钟刷新
使用动态价格: 开启
打开物品栏自动刷新: 开启
刷新价格快捷键: F10
```
**优点**:
- 每10分钟自动更新价格（打开物品栏时）
- 急需时可手动刷新
- 适合长时间游玩

---

## 🐛 故障排查

### 问题1：按 F10 没反应
**解决方案**:
1. 检查快捷键是否与其他 MOD 冲突
2. 打开配置管理器（F12）修改为其他键
3. 查看日志是否有错误信息

### 问题2：刷新失败
**可能原因**:
- 服务端未启动或崩溃
- 网络连接问题
- 服务端数据库损坏

**解决方案**:
1. 检查服务端日志
2. 重启服务端
3. 切换为静态价格模式测试

### 问题3：刷新后价格仍然是旧的
**解决方案**:
1. 重新悬停物品触发价格查询
2. 重新打开物品栏
3. 检查配置是否使用了"仅手动刷新"模式

---

## 🔄 与其他功能的关系

| 功能 | 关系 | 说明 |
|------|------|------|
| **打开物品栏自动刷新** | 互补 | 自动刷新是定期触发，手动刷新是即时触发 |
| **价格缓存模式** | 协同 | 永久缓存模式下，手动刷新是唯一的更新方式 |
| **地面物品着色** | 依赖 | 刷新后会自动清理颜色缓存，确保颜色更新 |
| **动态价格** | 协同 | 动态价格模式下刷新才有意义（静态价格不变） |

---

## 📝 更新日志

### v1.1.2 (当前版本)
- ✨ 新增快捷键手动刷新价格功能
- ✨ 添加防抖机制（5秒间隔）
- ✨ 添加详细的状态反馈日志
- ✨ 自动清理地面物品颜色缓存
- 🐛 修复了 System 命名空间缺失的编译错误

---

## 🎉 总结

手动刷新价格功能为玩家提供了更灵活的价格更新方式，特别适合以下场景：

1. **永久缓存模式用户**：不想频繁自动刷新，但偶尔需要更新价格
2. **跳蚤市场价格变动时**：游戏内物品价格大幅波动时快速更新
3. **调试和测试**：插件开发者或高级用户用于测试价格功能

配合已有的自动刷新功能，为不同需求的玩家提供了完善的价格更新解决方案。
