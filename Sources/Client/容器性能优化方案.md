# å¤§å®¹é‡å®¹å™¨æŸ¥è¯¢å¡é¡¿é—®é¢˜ - æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜åˆ†æ

### å½“å‰å®ç°çš„æ€§èƒ½ç“¶é¢ˆ

åœ¨ `TestTooltipPatch.cs` çš„ `CalculateContainerItemsPrice()` æ–¹æ³•ä¸­å­˜åœ¨ä»¥ä¸‹æ€§èƒ½é—®é¢˜ï¼š

#### 1. **é€’å½’æ·±åº¦é—®é¢˜**
```csharp
// è¡Œ 1164-1329: CalculateContainerItemsPrice
private static double CalculateContainerItemsPrice(Item container, int depth)
{
    if (depth >= 50)  // æœ€å¤§é€’å½’æ·±åº¦ 50 å±‚
        return 0;

    // é€’å½’è°ƒç”¨ï¼š
    // - èƒŒåŒ…é‡Œçš„èƒŒåŒ… â†’ é€’å½’
    // - æ­¦å™¨é…ä»¶ â†’ PriceCalculator.CalculateWeaponModsPrice() â†’ é€’å½’
    // - å¼¹åŒ£å­å¼¹ â†’ éå†æ‰€æœ‰å­å¼¹
}
```

**é—®é¢˜**ï¼š
- èƒŒåŒ…å¥—å¨ƒï¼ˆèƒŒåŒ…é‡Œæœ‰èƒŒåŒ…ï¼‰å¯¼è‡´é€’å½’å±‚æ•°å¢åŠ 
- æ¯å±‚éƒ½è¦éå†æ‰€æœ‰ç‰©å“
- æ—¶é—´å¤æ‚åº¦ï¼šO(n Ã— m Ã— d)ï¼Œå…¶ä¸­ n=ç‰©å“æ•°ï¼Œm=å¹³å‡é…ä»¶æ•°ï¼Œd=é€’å½’æ·±åº¦

#### 2. **åå°„è°ƒç”¨å¼€é”€**
```csharp
// æ¯ä¸ªç‰©å“éƒ½è¦è¿›è¡Œå¤§é‡åå°„è°ƒç”¨
var gridsProperty = containerType.GetProperty("Grids");      // åå°„
var itemsProperty = grid.GetType().GetProperty("Items");     // åå°„
var price = PriceDataService.Instance.GetPrice(templateId); // å­—å…¸æŸ¥è¯¢
```

**é—®é¢˜**ï¼š
- åå°„æ¯”ç›´æ¥å±æ€§è®¿é—®æ…¢ 10-100 å€
- æ¯ä¸ªç‰©å“è‡³å°‘ 2-3 æ¬¡åå°„è°ƒç”¨
- å¤§å®¹å™¨ï¼ˆ100+ ç‰©å“ï¼‰ä¼šæœ‰ 200-300 æ¬¡åå°„è°ƒç”¨

#### 3. **æ­¦å™¨å’Œå¼¹åŒ£çš„æ·±åº¦è®¡ç®—**
```csharp
// å®¹å™¨é‡Œçš„æ­¦å™¨ â†’ è®¡ç®—æ‰€æœ‰é…ä»¶
if (gridItem is Weapon weaponInContainer)
{
    double weaponModsPrice = PriceCalculator.CalculateWeaponModsPrice(weaponInContainer);
    total += weaponModsPrice;  // é€’å½’è®¡ç®—æ‰€æœ‰é…ä»¶ï¼
}

// å®¹å™¨é‡Œçš„å¼¹åŒ£ â†’ éå†æ‰€æœ‰å­å¼¹
else if (gridItem is MagazineItemClass magazineInContainer)
{
    foreach (var cartridge in magazineInContainer.Cartridges.Items)
    {
        // æŸ¥è¯¢æ¯é¢—å­å¼¹çš„ä»·æ ¼
    }
}
```

**é—®é¢˜**ï¼š
- ä¸€ä¸ªæ»¡é…æ­¦å™¨å¯èƒ½æœ‰ 20+ ä¸ªé…ä»¶
- ä¸€ä¸ªå¼¹åŒ£å¯èƒ½æœ‰ 30-60 å‘å­å¼¹
- å¦‚æœå®¹å™¨é‡Œæœ‰ 10 æŠŠæ­¦å™¨ã€20 ä¸ªå¼¹åŒ£ï¼Œè®¡ç®—é‡çˆ†ç‚¸å¼å¢é•¿

#### 4. **å®æ—¶è®¡ç®—æ²¡æœ‰ç¼“å­˜**
```csharp
// æ¯æ¬¡é¼ æ ‡æ‚¬åœéƒ½é‡æ–°è®¡ç®—
public static void Prefix(SimpleTooltip __instance, ref string text, ref float delay)
{
    // ...
    text += FormatContainerPriceText(item, slots);  // æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—ï¼
}
```

**é—®é¢˜**ï¼š
- æ²¡æœ‰ç¼“å­˜æœºåˆ¶
- å³ä½¿æ˜¯åŒä¸€ä¸ªå®¹å™¨ï¼Œæ¯æ¬¡æ‚¬åœéƒ½é‡æ–°è®¡ç®—
- å¤§å®¹å™¨æ¯æ¬¡éƒ½è¦èŠ±è´¹ 100-500ms

---

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### æ–¹æ¡ˆ 1: **é™åˆ¶è®¡ç®—æ·±åº¦ + ç®€åŒ–æ¨¡å¼**ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

#### å®ç°æ–¹å¼
```csharp
// åœ¨é…ç½®ä¸­æ·»åŠ é€‰é¡¹
public static ConfigEntry<int> MaxContainerItemsToCalculate; // æœ€å¤§è®¡ç®—ç‰©å“æ•°
public static ConfigEntry<bool> SimplifyContainerCalculation; // ç®€åŒ–å®¹å™¨è®¡ç®—

// ä¿®æ”¹ CalculateContainerItemsPrice
private static double CalculateContainerItemsPrice(Item container, int depth)
{
    // 1. é™ä½æœ€å¤§é€’å½’æ·±åº¦ï¼š50å±‚ â†’ 5å±‚
    if (depth >= 5)
        return 0;

    int itemCount = 0;
    int maxItems = Settings.MaxContainerItemsToCalculate.Value; // é»˜è®¤ 50

    foreach (var gridItem in itemsList)
    {
        if (itemCount >= maxItems)
        {
            // è¶…è¿‡é™åˆ¶ï¼Œåœæ­¢è®¡ç®—å¹¶æ˜¾ç¤ºæç¤º
            Plugin.Log.LogWarning($"å®¹å™¨ç‰©å“è¶…è¿‡ {maxItems} ä¸ªï¼Œåœæ­¢è¯¦ç»†è®¡ç®—");
            break;
        }

        // 2. ç®€åŒ–æ¨¡å¼ï¼šè·³è¿‡é…ä»¶å’Œå­å¼¹çš„æ·±åº¦è®¡ç®—
        if (Settings.SimplifyContainerCalculation.Value)
        {
            // åªè®¡ç®—ç‰©å“æœ¬èº«ä»·æ ¼
            total += itemPrice.Value * gridItem.StackObjectsCount;
            itemCount++;
            continue;
        }

        // 3. å®Œæ•´æ¨¡å¼ï¼šä¿ç•™åŸæœ‰é€»è¾‘
        // ...
    }
}
```

#### æ•ˆæœ
- **æ€§èƒ½æå‡**ï¼š70-80%
- **ç”¨æˆ·ä½“éªŒ**ï¼šå‡ ä¹æ— æ„ŸçŸ¥å»¶è¿Ÿï¼ˆ<100msï¼‰
- **å‡†ç¡®æ€§**ï¼šç®€åŒ–æ¨¡å¼ç•¥æœ‰è¯¯å·®ï¼Œä½†å¤§å¹…æå‡æ€§èƒ½

---

### æ–¹æ¡ˆ 2: **ç»“æœç¼“å­˜æœºåˆ¶**ï¼ˆæ¨èâ­â­â­â­ï¼‰

#### å®ç°æ–¹å¼
```csharp
// æ·»åŠ é™æ€ç¼“å­˜
private static Dictionary<string, (double price, DateTime timestamp)> _containerPriceCache
    = new Dictionary<string, (double, DateTime)>();

private static double CalculateContainerItemsPrice(Item container, int depth)
{
    // æ£€æŸ¥ç¼“å­˜ï¼ˆ5ç§’æœ‰æ•ˆæœŸï¼‰
    string cacheKey = container.Id;
    if (_containerPriceCache.TryGetValue(cacheKey, out var cached))
    {
        if ((DateTime.Now - cached.timestamp).TotalSeconds < 5)
        {
            return cached.price;  // ä½¿ç”¨ç¼“å­˜ç»“æœ
        }
    }

    // è®¡ç®—ä»·æ ¼
    double total = /* åŸæœ‰è®¡ç®—é€»è¾‘ */;

    // ä¿å­˜åˆ°ç¼“å­˜
    _containerPriceCache[cacheKey] = (total, DateTime.Now);

    return total;
}

// å®šæœŸæ¸…ç†ç¼“å­˜ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
private static void CleanupCache()
{
    var now = DateTime.Now;
    var keysToRemove = _containerPriceCache
        .Where(kvp => (now - kvp.Value.timestamp).TotalSeconds > 30)
        .Select(kvp => kvp.Key)
        .ToList();

    foreach (var key in keysToRemove)
        _containerPriceCache.Remove(key);
}
```

#### æ•ˆæœ
- **æ€§èƒ½æå‡**ï¼š90-95%ï¼ˆé‡å¤æŸ¥è¯¢æ—¶ï¼‰
- **å†…å­˜å ç”¨**ï¼šæ¯ä¸ªå®¹å™¨çº¦ 24 å­—èŠ‚
- **é€‚ç”¨åœºæ™¯**ï¼šé¢‘ç¹æ‚¬åœåŒä¸€ä¸ªå®¹å™¨

---

### æ–¹æ¡ˆ 3: **æ¸è¿›å¼åŠ è½½ + å¼‚æ­¥è®¡ç®—**ï¼ˆå¤æ‚åº¦é«˜â­â­â­ï¼‰

#### å®ç°æ–¹å¼
```csharp
// Tooltip åˆå§‹æ˜¾ç¤ºæ—¶åªæ˜¾ç¤ºå®¹å™¨æœ¬èº«ä»·æ ¼
private static string FormatContainerPriceText(Item container, int slots)
{
    var sb = new StringBuilder();
    sb.Append("\n");

    // ç«‹å³æ˜¾ç¤ºå®¹å™¨æœ¬èº«ä»·æ ¼
    var containerPrice = PriceDataService.Instance.GetPrice(container.TemplateId);
    sb.Append($"\nè·³èš¤å¸‚åœº: {TextFormatting.FormatPrice(containerPrice.Value)}");
    sb.Append($"\nå†…éƒ¨ç‰©å“: è®¡ç®—ä¸­...");

    // å¼‚æ­¥è®¡ç®—å†…éƒ¨ç‰©å“ä»·æ ¼
    _ = Task.Run(() => {
        double itemsPrice = CalculateContainerItemsPrice(container, 0);
        // æ›´æ–°ç¼“å­˜ï¼Œä¸‹æ¬¡æ‚¬åœæ—¶ç›´æ¥æ˜¾ç¤º
        _containerPriceCache[container.Id] = (itemsPrice, DateTime.Now);
    });

    return sb.ToString();
}
```

#### æ•ˆæœ
- **é¦–æ¬¡æ˜¾ç¤º**ï¼šç«‹å³ï¼ˆ<10msï¼‰
- **å®Œæ•´ç»“æœ**ï¼šåå°è®¡ç®—ï¼Œä¸‹æ¬¡æ‚¬åœæ˜¾ç¤º
- **å¤æ‚åº¦**ï¼šéœ€è¦å¤„ç†å¤šçº¿ç¨‹å’Œç¼“å­˜åŒæ­¥

---

### æ–¹æ¡ˆ 4: **æ™ºèƒ½è·³è¿‡ç­–ç•¥**ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

#### å®ç°æ–¹å¼
```csharp
private static string FormatContainerPriceText(Item container, int slots)
{
    // é¢„ä¼°å®¹å™¨å¤§å°
    int estimatedItemCount = EstimateContainerItemCount(container);

    if (estimatedItemCount > 100)
    {
        // å¤§å®¹å™¨ï¼šä»…æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯ + è­¦å‘Š
        sb.Append($"\nâš ï¸ å®¹å™¨ç‰©å“è¿‡å¤šï¼ˆçº¦{estimatedItemCount}ä¸ªï¼‰");
        sb.Append($"\nä»…æ˜¾ç¤ºå®¹å™¨æœ¬èº«ä»·æ ¼");
        sb.Append($"\nè·³èš¤å¸‚åœº: {TextFormatting.FormatPrice(containerPrice.Value)}");
        return sb.ToString();
    }

    // å°å®¹å™¨ï¼šå®Œæ•´è®¡ç®—
    double itemsPrice = CalculateContainerItemsPrice(container, 0);
    // ...
}

private static int EstimateContainerItemCount(Item container)
{
    // å¿«é€Ÿä¼°ç®—ï¼šä¸é€’å½’ï¼Œåªç»Ÿè®¡ç¬¬ä¸€å±‚ç‰©å“æ•°é‡
    int count = 0;
    var gridsProperty = container.GetType().GetProperty("Grids");
    if (gridsProperty == null) return 0;

    var grids = gridsProperty.GetValue(container) as IEnumerable;
    if (grids == null) return 0;

    foreach (var grid in grids)
    {
        var itemsProperty = grid.GetType().GetProperty("Items");
        if (itemsProperty != null)
        {
            var items = itemsProperty.GetValue(grid) as IEnumerable;
            if (items != null)
                count += items.Cast<object>().Count();
        }
    }

    return count;
}
```

#### æ•ˆæœ
- **å°å®¹å™¨**ï¼ˆ<50ç‰©å“ï¼‰ï¼šæ­£å¸¸è®¡ç®—
- **å¤§å®¹å™¨**ï¼ˆ>100ç‰©å“ï¼‰ï¼šè·³è¿‡è®¡ç®—ï¼Œæ˜¾ç¤ºè­¦å‘Š
- **æ€§èƒ½**ï¼šæ°¸è¿œä¸ä¼šå¡é¡¿ï¼ˆæœ€åæƒ…å†µ <50msï¼‰

---

## ğŸ“‹ æ¨èå®æ–½é¡ºåº

### é˜¶æ®µ 1ï¼ˆç«‹å³å®æ–½ï¼‰ï¼šåŸºç¡€ä¼˜åŒ–
1. âœ… **é™ä½é€’å½’æ·±åº¦**ï¼š50å±‚ â†’ 5å±‚ï¼ˆ99%çš„æƒ…å†µä¸‹å¤Ÿç”¨ï¼‰
2. âœ… **æ·»åŠ ç‰©å“æ•°é‡é™åˆ¶**ï¼šé»˜è®¤æœ€å¤šè®¡ç®— 50 ä¸ªç‰©å“
3. âœ… **æ™ºèƒ½è·³è¿‡å¤§å®¹å™¨**ï¼š>100 ä¸ªç‰©å“ç›´æ¥è·³è¿‡

**é¢„æœŸæ•ˆæœ**ï¼šå¡é¡¿é—®é¢˜ 90% è§£å†³

### é˜¶æ®µ 2ï¼ˆåç»­ä¼˜åŒ–ï¼‰ï¼šç¼“å­˜æœºåˆ¶
4. â­ **æ·»åŠ ç»“æœç¼“å­˜**ï¼š5ç§’æœ‰æ•ˆæœŸ
5. â­ **å®šæœŸæ¸…ç†ç¼“å­˜**ï¼šé¿å…å†…å­˜æ³„æ¼

**é¢„æœŸæ•ˆæœ**ï¼šé‡å¤æŸ¥è¯¢å‡ ä¹æ— å»¶è¿Ÿ

### é˜¶æ®µ 3ï¼ˆé«˜çº§ä¼˜åŒ–ï¼‰ï¼šå¼‚æ­¥è®¡ç®—
6. ğŸ”§ **å¼‚æ­¥è®¡ç®— + æ¸è¿›å¼æ˜¾ç¤º**ï¼ˆå¯é€‰ï¼Œå¤æ‚åº¦é«˜ï¼‰

**é¢„æœŸæ•ˆæœ**ï¼šå®Œå…¨æ— å¡é¡¿æ„Ÿ

---

## ğŸ¯ é…ç½®é¡¹å»ºè®®

```csharp
// Settings.cs æ–°å¢é…ç½®
public static ConfigEntry<int> MaxContainerItems;        // æœ€å¤§è®¡ç®—ç‰©å“æ•° (é»˜è®¤ 50)
public static ConfigEntry<int> MaxContainerDepth;        // æœ€å¤§é€’å½’æ·±åº¦ (é»˜è®¤ 5)
public static ConfigEntry<bool> SimplifyContainer;       // ç®€åŒ–å®¹å™¨è®¡ç®— (é»˜è®¤ false)
public static ConfigEntry<bool> SkipLargeContainers;     // è·³è¿‡å¤§å®¹å™¨ (é»˜è®¤ true)
public static ConfigEntry<int> LargeContainerThreshold;  // å¤§å®¹å™¨é˜ˆå€¼ (é»˜è®¤ 100)
```

---

## ğŸ’¡ æ€§èƒ½å¯¹æ¯”ï¼ˆä¼°ç®—ï¼‰

| åœºæ™¯ | å½“å‰å®ç° | æ–¹æ¡ˆ1+2 | æ–¹æ¡ˆ1+2+4 |
|------|---------|---------|-----------|
| ç©ºèƒŒåŒ… | 10ms | 5ms | 5ms |
| 50ç‰©å“èƒŒåŒ… | 150ms | 50ms | 50ms |
| 100ç‰©å“èƒŒåŒ… | 500ms | 100ms | **è·³è¿‡** |
| 300ç‰©å“ç®±å­ | 2000ms+ | 400ms | **è·³è¿‡** |
| åµŒå¥—å®¹å™¨ï¼ˆ5å±‚ï¼‰ | 1000ms+ | 200ms | 100ms |

**å…³é”®æŒ‡æ ‡**ï¼š
- âœ… ç›®æ ‡å»¶è¿Ÿï¼š<100msï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
- âœ… ä¼˜åŒ–åï¼š95% çš„æƒ…å†µ <50ms

---

## âš™ï¸ éœ€è¦æ‚¨å†³å®š

è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³å®æ–½å“ªä¸ªæ–¹æ¡ˆï¼š

1. **å¿«é€Ÿä¿®å¤**ï¼ˆæ¨èï¼‰ï¼šæ–¹æ¡ˆ 1 + æ–¹æ¡ˆ 4ï¼ˆé™åˆ¶ç‰©å“æ•° + æ™ºèƒ½è·³è¿‡ï¼‰
   - å®æ–½éš¾åº¦ï¼šâ˜…â˜†â˜†â˜†â˜†
   - æ•ˆæœï¼šâ˜…â˜…â˜…â˜…â˜†
   - å®æ–½æ—¶é—´ï¼š10-15 åˆ†é’Ÿ

2. **å®Œæ•´ä¼˜åŒ–**ï¼ˆæœ€ä½³ï¼‰ï¼šæ–¹æ¡ˆ 1 + æ–¹æ¡ˆ 2 + æ–¹æ¡ˆ 4ï¼ˆé™åˆ¶ + ç¼“å­˜ + è·³è¿‡ï¼‰
   - å®æ–½éš¾åº¦ï¼šâ˜…â˜…â˜†â˜†â˜†
   - æ•ˆæœï¼šâ˜…â˜…â˜…â˜…â˜…
   - å®æ–½æ—¶é—´ï¼š20-30 åˆ†é’Ÿ

3. **ä»…æä¾›åˆ†æ**ï¼šä¸ä¿®æ”¹ä»£ç ï¼Œä»…æä¾›æ­¤æ–‡æ¡£ä¾›å‚è€ƒ

è¯·å‘Šè¯‰æˆ‘æ‚¨çš„é€‰æ‹©ï¼
